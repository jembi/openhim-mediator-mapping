"use strict";(self.webpackChunkmapping_mediator=self.webpackChunkmapping_mediator||[]).push([[356],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||o;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8215:function(e,t,n){var a=n(7294);t.Z=function(e){var t=e.children,n=e.hidden,r=e.className;return a.createElement("div",{role:"tabpanel",hidden:n,className:r},t)}},6396:function(e,t,n){n.d(t,{Z:function(){return c}});var a=n(3117),r=n(7294),o=n(2389),i=n(9443);var l=function(){var e=(0,r.useContext)(i.Z);if(null==e)throw new Error('"useUserPreferencesContext" is used outside of "Layout" component.');return e},s=n(6681),p=n(6010),u="tabItem_1uMI";function d(e){var t,n,o,i=e.lazy,d=e.block,c=e.defaultValue,m=e.values,h=e.groupId,f=e.className,g=r.Children.map(e.children,(function(e){if((0,r.isValidElement)(e)&&void 0!==e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),k=null!=m?m:g.map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes}})),b=(0,s.lx)(k,(function(e,t){return e.value===t.value}));if(b.length>0)throw new Error('Docusaurus error: Duplicate values "'+b.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var v=null===c?c:null!=(t=null!=c?c:null==(n=g.find((function(e){return e.props.default})))?void 0:n.props.value)?t:null==(o=g[0])?void 0:o.props.value;if(null!==v&&!k.some((function(e){return e.value===v})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+v+'" but none of its children has the corresponding value. Available values are: '+k.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var y=l(),N=y.tabGroupChoices,w=y.setTabGroupChoices,T=(0,r.useState)(v),q=T[0],x=T[1],j=[],C=(0,s.o5)().blockElementScrollPositionUntilNextRender;if(null!=h){var E=N[h];null!=E&&E!==q&&k.some((function(e){return e.value===E}))&&x(E)}var I=function(e){var t=e.currentTarget,n=j.indexOf(t),a=k[n].value;a!==q&&(C(t),x(a),null!=h&&w(h,a))},O=function(e){var t,n=null;switch(e.key){case"ArrowRight":var a=j.indexOf(e.currentTarget)+1;n=j[a]||j[0];break;case"ArrowLeft":var r=j.indexOf(e.currentTarget)-1;n=j[r]||j[j.length-1]}null==(t=n)||t.focus()};return r.createElement("div",{className:"tabs-container"},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,p.Z)("tabs",{"tabs--block":d},f)},k.map((function(e){var t=e.value,n=e.label,o=e.attributes;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:q===t?0:-1,"aria-selected":q===t,key:t,ref:function(e){return j.push(e)},onKeyDown:O,onFocus:I,onClick:I},o,{className:(0,p.Z)("tabs__item",u,null==o?void 0:o.className,{"tabs__item--active":q===t})}),null!=n?n:t)}))),i?(0,r.cloneElement)(g.filter((function(e){return e.props.value===q}))[0],{className:"margin-vert--md"}):r.createElement("div",{className:"margin-vert--md"},g.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==q})}))))}function c(e){var t=(0,o.Z)();return r.createElement(d,(0,a.Z)({key:String(t)},e))}},4011:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return p},contentTitle:function(){return u},metadata:function(){return d},toc:function(){return c},default:function(){return h}});var a=n(3117),r=n(102),o=(n(7294),n(3905)),i=n(6396),l=n(8215),s=["components"],p={id:"endpoints",title:"Endpoints",sidebar_label:"Endpoints"},u=void 0,d={unversionedId:"gettingStarted/endpoints",id:"gettingStarted/endpoints",title:"Endpoints",description:"Endpoint Configuration",source:"@site/docs/gettingStarted/endpoints.md",sourceDirName:"gettingStarted",slug:"/gettingStarted/endpoints",permalink:"/openhim-mediator-mapping/docs/gettingStarted/endpoints",editUrl:"https://github.com/jembi/openhim-mediator-mapping/edit/master/docs/docs/gettingStarted/endpoints.md",tags:[],version:"current",frontMatter:{id:"endpoints",title:"Endpoints",sidebar_label:"Endpoints"},sidebar:"someSidebar",previous:{title:"Setup",permalink:"/openhim-mediator-mapping/docs/gettingStarted/setup"},next:{title:"Mapping Mediator API",permalink:"/openhim-mediator-mapping/docs/gettingStarted/api"}},c=[{value:"Endpoint Configuration",id:"endpoint-configuration",children:[{value:"1. Metadata",id:"1-metadata",children:[{value:"Route Path Pattern",id:"route-path-pattern",children:[],level:4},{value:"Expected Input",id:"expected-input",children:[],level:4},{value:"Desired Output",id:"desired-output",children:[],level:4},{value:"Kafka Input Topic",id:"kafka-input-topic",children:[],level:4}],level:3},{value:"2. Mapping",id:"2-mapping",children:[{value:"Data available for mapping",id:"data-available-for-mapping",children:[],level:4}],level:3},{value:"3. Constants",id:"3-constants",children:[],level:3},{value:"4. Validation",id:"4-validation",children:[],level:3},{value:"5. Transformation",id:"5-transformation",children:[],level:3},{value:"6. Orchestrations",id:"6-orchestrations",children:[],level:3},{value:"7. State",id:"7-state",children:[],level:3}],level:2}],m={toc:c};function h(e){var t=e.components,n=(0,r.Z)(e,s);return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"endpoint-configuration"},"Endpoint Configuration"),(0,o.kt)("p",null,"Each ",(0,o.kt)("inlineCode",{parentName:"p"},"Endpoint")," is configured independently with a schema stored in MongoDB.\nThe schemas are defined as JSON objects. Endpoints are added to the Mapping Mediator via its API.\nIn the example below, we post a simple example endpoint to our local API endpoint which defaults to ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:3003/endpoints"},"http://localhost:3003/endpoints"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'curl --location --request POST \'http://localhost:3003/endpoints\' \\\n--header \'Content-Type: application/json\' \\\n--data-raw \'{\n    "name": "Endpoint Example",\n    "endpoint": {\n        "pattern": "/example",\n        "method": "GET"\n    },\n    "transformation": {\n        "input": "JSON",\n        "output": "JSON"\n    },\n    "inputMapping": {\n      "constants.example_constant":"hello"\n    },\n    "constants": {\n      "example_constant": "world!"\n    }\n}\'\n')),(0,o.kt)("p",null,"This is a RESTful API that supports POST, PUT, GET, and DELETE. Therefore, once an ",(0,o.kt)("inlineCode",{parentName:"p"},"Endpoint")," has been created it can be retrieved, updated, and deleted. For more information, please see the ",(0,o.kt)("a",{parentName:"p",href:"/openhim-mediator-mapping/docs/gettingStarted/api"},"Mapping Mediator API")," documentation."),(0,o.kt)("p",null,"The schema can be broken down into 7 major areas of concern:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Metadata"),(0,o.kt)("li",{parentName:"ol"},"Mapping"),(0,o.kt)("li",{parentName:"ol"},"Constants"),(0,o.kt)("li",{parentName:"ol"},"Validation"),(0,o.kt)("li",{parentName:"ol"},"Transformation"),(0,o.kt)("li",{parentName:"ol"},"Orchestration"),(0,o.kt)("li",{parentName:"ol"},"State")),(0,o.kt)("h3",{id:"1-metadata"},"1. Metadata"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"metadata")," section contains the details involved in route setup. The following can be set in the root level of the config object:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Endpoint ",(0,o.kt)("inlineCode",{parentName:"li"},"name")),(0,o.kt)("li",{parentName:"ul"},"Endpoint ",(0,o.kt)("inlineCode",{parentName:"li"},"description")),(0,o.kt)("li",{parentName:"ul"},"Route path ",(0,o.kt)("inlineCode",{parentName:"li"},"pattern")),(0,o.kt)("li",{parentName:"ul"},"Route HTTP ",(0,o.kt)("inlineCode",{parentName:"li"},"method")),(0,o.kt)("li",{parentName:"ul"},"Expected ",(0,o.kt)("inlineCode",{parentName:"li"},"input")," message data type"),(0,o.kt)("li",{parentName:"ul"},"Desired ",(0,o.kt)("inlineCode",{parentName:"li"},"output")," message data type"),(0,o.kt)("li",{parentName:"ul"},"Kakfa Input Topic ",(0,o.kt)("inlineCode",{parentName:"li"},"kafkaConsumerTopic"))),(0,o.kt)("h4",{id:"route-path-pattern"},"Route Path Pattern"),(0,o.kt)("p",null,"This is the path on which the OpenHIM Mapping Mediator will listen to trigger a specific message mapping transformation. The path is specified in the endpoint ",(0,o.kt)("inlineCode",{parentName:"p"},"pattern")," property. Url parameters are supported. The URL parameters can be used in the external requests and in the mapping. A request that matches on a pattern like ",(0,o.kt)("inlineCode",{parentName:"p"},"/path/:parameter1/:parameter2")," will have the values of these parameters available for use in the external requests and mapping under variable names ",(0,o.kt)("inlineCode",{parentName:"p"},"parameter1")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"parameter2"),"."),(0,o.kt)("h4",{id:"expected-input"},"Expected Input"),(0,o.kt)("p",null,"Specify the expected input message type for this specific endpoint to allow the OpenHIM Mapping Mediator to successfully parse the incoming message for processing. Currently accepted formats are ",(0,o.kt)("inlineCode",{parentName:"p"},"JSON")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"XML")),(0,o.kt)("h4",{id:"desired-output"},"Desired Output"),(0,o.kt)("p",null,"Specify the desired output message type for this specific endpoint to allow the OpenHIM Mapping Mediator to parse the outgoing message. Currently accepted formats are ",(0,o.kt)("inlineCode",{parentName:"p"},"JSON")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"XML")),(0,o.kt)("h4",{id:"kafka-input-topic"},"Kafka Input Topic"),(0,o.kt)("p",null,"Specify the kafka topic to consume data from using property ",(0,o.kt)("inlineCode",{parentName:"p"},"kafkaConsumerTopic"),"."),(0,o.kt)("h3",{id:"2-mapping"},"2. Mapping"),(0,o.kt)("p",null,"The mapping schema is defined within the ",(0,o.kt)("inlineCode",{parentName:"p"},"input-mapping"),"field. This section defines how the incoming data will be used to build up a new object in the desired structure. Our mapping is done using the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/jembi/node-object-mapper"},"node object mapper library"),"."),(0,o.kt)("p",null,"Every mapping field in this section follows this pattern"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "path.to.input.data": "path.to.output.field"\n}\n')),(0,o.kt)("h4",{id:"data-available-for-mapping"},"Data available for mapping"),(0,o.kt)("p",null,"All input data, populated from different sources, are stored in the following internal object structure:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requestBody": {...},\n  "requestHeaders": {...}, // Only in versions above v2.3.1\n  "lookupRequests": {\n    "<id>": {\n      "headers": {...},\n      "data": {...} // response body\n    }\n  },\n\n  // In versions below v3.0.0 the lookupRequests has the following structure\n  "lookupRequests": {\n    "<id>": {...} // response body\n  },\n  "transforms": {...},\n  "constants": {...},\n  "urlParams": {...},\n  "state": {...},\n  "timestamps": {...}\n}\n')),(0,o.kt)("p",null,"See the full flow of examples to follow:"),(0,o.kt)(i.Z,{defaultValue:"input",values:[{label:"Input Data",value:"input"},{label:"Mapping Schema",value:"mapping"},{label:"Output",value:"output"}],mdxType:"Tabs"},(0,o.kt)(l.Z,{value:"input",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requestBody": {\n    "status": "Active"\n  },\n  "lookupRequests": {\n    "location": {\n      "data": "Unknown",\n      "headers": {\n        "type": "live"\n      }\n    }\n  }\n}\n'))),(0,o.kt)(l.Z,{value:"mapping",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "inputMapping": {\n    "requestBody.status": "status",\n    "lookupRequests.location.data": "location",\n    "lookupRequests.location.headers.type": "locationType"\n  }\n}\n'))),(0,o.kt)(l.Z,{value:"output",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "status": "Active",\n  "location": "Unknown",\n  "locationType": "live"\n}\n')))),(0,o.kt)("h3",{id:"3-constants"},"3. Constants"),(0,o.kt)("p",null,"The constants section contains data to be used alongside the client input data. This contains values for fields required in the output data that weren't available from the original client input."),(0,o.kt)("p",null,"Fields in constants can only be referenced in the transformation, orchestration and mapping sections of the Endpoint schema. See below for a simple example:"),(0,o.kt)(i.Z,{defaultValue:"definition",values:[{label:"Constants Definition",value:"definition"},{label:"Constants Reference",value:"reference"},{label:"Output",value:"output"}],mdxType:"Tabs"},(0,o.kt)(l.Z,{value:"definition",mdxType:"TabItem"},(0,o.kt)("p",null,"Here we define two constants."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'"constants": {\n  "first_constant": "world",\n  "second_constant": 3.1415\n}\n'))),(0,o.kt)(l.Z,{value:"reference",mdxType:"TabItem"},(0,o.kt)("p",null,"The constants are mapped to new output fields ",(0,o.kt)("inlineCode",{parentName:"p"},"hello")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"pi")," respectively."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'  "inputMapping": {\n    "constants.first_constant": "hello",\n    "constants.second_constant": "pi",\n  }\n'))),(0,o.kt)(l.Z,{value:"output",mdxType:"TabItem"},(0,o.kt)("p",null,"The output object then contains constant data independent of the input request data."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "hello": "world",\n  "pi": 3.1415\n}\n')))),(0,o.kt)("h3",{id:"4-validation"},"4. Validation"),(0,o.kt)("p",null,"The data from the input request as well as any lookup requests can be validated before the mapping occurs. We use the ",(0,o.kt)("a",{parentName:"p",href:"https://ajv.js.org/"},"ajv library")," to handle our validation. Below is a sample of a validation schema:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "object",\n  "properties": {\n    "name": {\n      "type": "string"\n    },\n    "weight": {\n      "type": "number",\n      "min": 0.1,\n      "max": 650,\n      "errorMessage": "Weight must be a number between 0.1 and 650"\n    }\n  },\n  "required": ["name"]\n}\n')),(0,o.kt)("p",null,"This schema will verify a message contains a ",(0,o.kt)("strong",{parentName:"p"},"required")," field called ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," of type string and an ",(0,o.kt)("strong",{parentName:"p"},"optional")," field called ",(0,o.kt)("inlineCode",{parentName:"p"},"weight")," that if provided, is a number within the range 0.1 to 650."),(0,o.kt)("p",null,"For more details, see the ",(0,o.kt)("a",{parentName:"p",href:"/openhim-mediator-mapping/docs/features/validation"},"validation page"),"."),(0,o.kt)("h3",{id:"5-transformation"},"5. Transformation"),(0,o.kt)("p",null,"The transformation step allows data to undergo complex changes before the mapping step. The Mapping Mediator makes use of the ",(0,o.kt)("a",{parentName:"p",href:"http://docs.jsonata.org/overview.html"},"JSONata library")," to perform transformations. Transformed data and the original input are both available to be mapped in the mapping step."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Note: Transformed data will not be included in the output data unless it is mapped to an output field")),(0,o.kt)(i.Z,{defaultValue:"input",values:[{label:"Input Data",value:"input"},{label:"Transformation Reference",value:"reference"},{label:"Output",value:"output"}],mdxType:"Tabs"},(0,o.kt)(l.Z,{value:"input",mdxType:"TabItem"},(0,o.kt)("p",null,"Here we define two input request fields."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "radius": "10",\n  "subject": "world"\n}\n'))),(0,o.kt)(l.Z,{value:"reference",mdxType:"TabItem"},(0,o.kt)("p",null,"The transform schema definition:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:"{2,3}","{2,3}":!0},'  "inputTransforms": {\n    "areaOfObject": "(constants.pi * requestBody.radius * requestBody.radius) & \'cm\xb3\'",\n    "capsSubject": "$uppercase( requestBody.subject )"\n  },\n  "inputMapping": {\n    "transforms.capsSubject": "HELLO",\n    "transforms.areaOfObject": "mediumPizzaArea",\n  },\n  "constants": {\n    "pi": 3.1415\n  }\n'))),(0,o.kt)(l.Z,{value:"output",mdxType:"TabItem"},(0,o.kt)("p",null,"The output object then contains the transformed and mapped data"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "HELLO": "WORLD",\n  "mediumPizzaArea": "314.15cm\xb3"\n}\n')))),(0,o.kt)("p",null,"For more details check out ",(0,o.kt)("a",{parentName:"p",href:"../features/transformation"},"transformation")),(0,o.kt)("h3",{id:"6-orchestrations"},"6. Orchestrations"),(0,o.kt)("p",null,"This feature allows for data lookups from external services and the sending of the mapped data to external services.\nThe data to look up and the services where the result of the mapping should be sent are specified in the ",(0,o.kt)("inlineCode",{parentName:"p"},"requests")," section.\nThe data looked up is aggregated with the input data before the validation is done. Response data is not validated before being sent.\nFor more orchestrations details please see the ",(0,o.kt)("a",{parentName:"p",href:"../features/orchestration"},"Orchestrations feature documentation"),".\nBelow is an extract of some request orchestrations."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "requests": {\n    "lookup": [\n      {\n        "id": "dhis2",\n        "config": {\n          "method": "get",\n          "url": "https://play.dhis2.org/2.35/api/organisationUnits.json?paging=false",\n          "headers": {\n            "Content-Type": "application/json",\n            "Authorization": "Basic YWRtaW46ZGlzdHJpY3Q="\n          }\n        }\n      }\n    ],\n    "response": [\n      {\n        "id": "hapi-fhir",\n        "config": {\n          "method": "post",\n          "url": "http://hapi.fhir.org/baseR4/",\n          "headers": {\n            "Content-Type": "application/json"\n          }\n        }\n      }\n    ]\n  }\n}\n')),(0,o.kt)("p",null,"In the example above, the lookup request gets facility data from DHIS2. That data would then be mapped (schema not shown for brevity) and the output data sent to a FHIR server. These requests can include query and url parameters which can be extracted from incoming data. Chaining together endpoint calls using this orchestration mechanism can lead to very complex logic being implemented."),(0,o.kt)("p",null,"There are two types of external requests, the ",(0,o.kt)("inlineCode",{parentName:"p"},"lookup")," and the ",(0,o.kt)("inlineCode",{parentName:"p"},"response"),". Query and url parameters for the external request can be dynamically populated"),(0,o.kt)(i.Z,{defaultValue:"lookup",values:[{label:"Lookup",value:"lookup"},{label:"Response",value:"response"},{label:"Query and URL parameters",value:"query"},{label:"ForEach requests",value:"forEach"}],mdxType:"Tabs"},(0,o.kt)(l.Z,{value:"lookup",mdxType:"TabItem"},(0,o.kt)("p",null,"  You can fetch data to map. The retrieved data will be aggregated with the input data supplied in the request body. The following shows the aggregation"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:"{7}","{7}":!0},'Lookup request:\n\n{\n  "requests": {\n    "lookup": [\n      {\n        "id": "dhis2",\n        "config": {\n          "method": "get",\n          "url": "https://play.dhis2.org/2.35/api/organisationUnits.json?paging=false",\n          "headers": {\n            "Content-Type": "application/json",\n            "Authorization": "Basic YWRtaW46ZGlzdHJpY3Q="\n          }\n        }\n      }\n    ]\n  }\n}\n')),(0,o.kt)("p",null,"  The data retrived from the lookup request will be aggregated inside the lookupRequests object using its id as the nested field name. The full list off input data available for mapping is listed ",(0,o.kt)("a",{parentName:"p",href:"#data-available-for-mapping"},"above"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'  {\n    ...\n    "lookupRequests": {\n      "dhis2": {\n        "data": {...},\n        "headers": {...}\n      }\n    }\n  }\n'))),(0,o.kt)(l.Z,{value:"response",mdxType:"TabItem"},(0,o.kt)("p",null,"  The result of the mapping can be orchestrated to external services.\nThe result that will be sent back to the user in the response from the external services.\nIf the mapped data is being orchestrated to multiple services, the response sent back is an aggregation of the responses from the multiple services unless one of the external requests is set to be the ",(0,o.kt)("inlineCode",{parentName:"p"},"primary"),"."),(0,o.kt)("p",null,"  The examples below show the expected responses when there is a primary request and when there is not."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'//Primary request specified\n{\n  "requests": {\n    "response": [\n      {\n        "id": "dhis",\n        "config": {\n          "method": "post",\n          "url": "http://localhost:3000/example/",\n        }\n      },\n      {\n        "id": "redcap",\n        "config": {\n          "method": "post",\n          "url": "http://localhost:3444/example/",\n          "primary": false\n        }\n      },\n      // for producing to kafka\n      {\n        "id": "kafka",\n        "kafkaProducerTopic": "2xx"\n      }\n    ]\n  }\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'// Expected response:\n{\n  "body": {\n    "dhis": {\n      ...\n      // Response from dhis\n    },\n    "redcap": {\n      ...\n      // Response from redcap\n    }\n  }\n}\n')),(0,o.kt)("p",null,"  If one request has the property primary set to true or when there is only one request, the expected response is what is shown below"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"{\n  body: {\n  ...\n   // Primary Response body\n  }\n}\n"))),(0,o.kt)(l.Z,{value:"query",mdxType:"TabItem"},(0,o.kt)("p",null,"  The query or URL parameters for the external requests can be populated from the incoming request's body and query object.\nThe parameters to be added can be specified in the lookup config as shown below in the ",(0,o.kt)("inlineCode",{parentName:"p"},"params")," object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "requests": {\n    "lookup": [\n      {\n        "id": "iscec",\n        "config": {\n          "method": "get",\n          "url": "http://localhost:3444/encounters/:encounterId",\n          "params": {\n            "query": {\n              "id": {\n                "path": "payload.id",\n                "prefix": "prefix",\n                "postfix": "postfix"\n              }\n            },\n            "url": {\n              "encounterId": {\n                "path": "payload.encounterId"\n              }\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n')),(0,o.kt)("p",null,"  The ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," is the name of the query parameter. The ",(0,o.kt)("inlineCode",{parentName:"p"},"path")," is the location of the value of the parameter in the incoming request body or query object.\nFor values retrieved from the request body the ",(0,o.kt)("inlineCode",{parentName:"p"},"path")," is specified by prefixing the path with the key word ",(0,o.kt)("inlineCode",{parentName:"p"},"payload")," and for retrieving from the query the keyword is ",(0,o.kt)("inlineCode",{parentName:"p"},"query"),".\nBelow are examples of paths."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "config": {\n    "params": {\n      "query": {\n        "id": {\n          "path": "payload.ids[0].nationalId"\n        },\n        "name": {\n          "path": "query.name"\n        }\n      }\n    }\n  }\n}\n')),(0,o.kt)("p",null,"  The properties ",(0,o.kt)("inlineCode",{parentName:"p"},"postfix")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"prefix")," are optional.\nFor a query parameter that has the following format ",(0,o.kt)("inlineCode",{parentName:"p"},"code:<Facility code>:section:52"),", if we are retrieving the ",(0,o.kt)("inlineCode",{parentName:"p"},"Facility code")," from the payload or query we can specify this as shown below."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "params": {\n    "query": {\n      "filter": {\n        "path": "payload.facility_code",\n        "prefix": "code:",\n        "postfix": ":section:52"\n      }\n    }\n  }\n}\n')),(0,o.kt)("p",null,"  If for example the facility code in the payload is ",(0,o.kt)("strong",{parentName:"p"},"1223"),", the specification above will enable us to have a query parameter - ",(0,o.kt)("strong",{parentName:"p"},"?filter=code:1223:section:52")),(0,o.kt)("p",null,"  For URL parameter the name of the parameter must be included in the url with a ",(0,o.kt)("inlineCode",{parentName:"p"},":")," prefix. This parameter will be replaced in the URL at runtime with the value that you specify. For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requests": {\n    "lookup": [\n      {\n        "id": "iscec",\n        "config": {\n          "method": "get",\n          "url": "http://localhost:3444/encounters/:encounterId",\n          "params": {\n            "url": {\n              "encounterId": {\n                "path": "payload.encounterId"\n              }\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n')),(0,o.kt)("p",null,"  If the original request's payload had a ",(0,o.kt)("inlineCode",{parentName:"p"},"encounterId")," property of ",(0,o.kt)("inlineCode",{parentName:"p"},"2442")," then the url would become: ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:3444/encounters/2442"))),(0,o.kt)(l.Z,{value:"forEach",mdxType:"TabItem"},(0,o.kt)("p",null,"  Both lookups and responses support ForEach requests. These are requests that are executed for each element in an array variable. The configuration for these requests is done using the ",(0,o.kt)("inlineCode",{parentName:"p"},"forEach")," property on the request object as shown below:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:"{5-8}","{5-8}":!0},'{\n  "lookup": [\n    {\n      "id": "test",\n      "forwardExistingRequestBody": true, // If you need access to the payload this field MUST be specified\n      "forEach": {\n        "items": "payload.entry",\n        "concurrency": "2" // if not specified defaults to 1\n      },\n      "config": {\n      }\n    }\n  ]\n}\n')),(0,o.kt)("p",null,"  Configuration reference:"),(0,o.kt)("p",null,"  ",(0,o.kt)("inlineCode",{parentName:"p"},"items"),": this is the path to any stored variable which must resolve to an array, a request will fire for each array element\n",(0,o.kt)("inlineCode",{parentName:"p"},"concurrency"),": (optional) how many requests to execute at any one time, defaults to 1."),(0,o.kt)("p",null,"  The current item in the list is also made available as a variable for the requests to use so that each request may be dynamic. E.g:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:"{9,13}","{9,13}":!0},'{\n  "id": "fhirPatient",\n  "forwardExistingRequestBody": true,\n  "forEach": {\n    "items": "payload.test"\n  },\n  "config": {\n    "method": "post",\n    "url": "http://localhost:8080/Patient/:id",\n    "params": {\n      "url": {\n        "id": {\n          "path": "item.id"\n        }\n      }\n    }\n  }\n}\n')))),(0,o.kt)("h3",{id:"7-state"},"7. State"),(0,o.kt)("p",null,"The state management configuration is a useful feature when the results of previous requests influence details within the current request.\nFor example, say you want to poll for recent data within a range - using the endpoint state you could store when the last time this Endpoint was triggered and use that state value as the timestamp within your period request.\nPlease see the ",(0,o.kt)("a",{parentName:"p",href:"../features/state-management"},"feature documentation")," for an in-depth look at Endpoint State."),(0,o.kt)("p",null,"In the example below, we are extracting two fields to be stored on the Endpoint State. The organisationId is taken from the current requestBody. The pageNumber is taken from the current page query value."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:"{6,9}","{6,9}":!0},'{\n  ...\n  "state": {\n  "extract": {\n    "requestBody": {\n      "organisationId": "organisation[0].facilityId"\n    },\n    "query": {\n      "pageNumber": "page"\n    }\n  }\n}\n')),(0,o.kt)("p",null,"In the next request to this stateful endpoint the previous requests values will be available within the full list off input data available for mapping is listed ",(0,o.kt)("a",{parentName:"p",href:"#data-available-for-mapping"},"above"),". The two stored fields would be available as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:"{7-14}","{7-14}":!0},'{\n  "requestBody": {...},\n  "lookupRequests": {...},\n  "transforms": {...},\n  "constants": {...},\n  "urlParams": {...},\n  "state": {\n    "requestBody": {\n      "organisationId": "<id_value"\n    },\n    "query": {\n      "pageNumber": "<page_number_value>"\n    }\n  },\n  "timestamps": {...},\n}\n')),(0,o.kt)("p",null,"Therefore to reference the value in a schema for example you could use the follow:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:"{13,18}","{13,18}":!0},'{\n  ...\n  "requests": {\n    "lookup": [\n      {\n        "id": "organisation-details",\n        "config": {\n          "method": "get",\n          "url": "https://play.dhis2.org/2.35/api/organisationUnits/:org-id",\n          "params": {\n            "url": {\n              "org-id": {\n                "path": "state.requestBody.organisationId"\n              }\n            },\n            "query": {\n              "pageNumber": {\n                "path": "state.query.pageNumber"\n              }\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n')),(0,o.kt)("p",null,"This would result in a url with this format:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-http"},"https://play.dhis2.org/2.35/api/organisationUnits/<id_value>?pageNumber=<page_number_value>\n")))}h.isMDXComponent=!0}}]);